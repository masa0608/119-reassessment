<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>救急要請の再判断アシスト（オフライン版）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{
    --bg1:#fff; --bg2:#f9fbff; --ink:#111; --muted:#666;
    --red:#dc2626; --orange:#f97316; --amber:#f59e0b; --green:#059669; --blue:#2563eb;
    --card:#ffffffcc; --border:#e5e7eb;
  }
  html,body{margin:0;padding:0;background:linear-gradient(135deg,#fff4f5,#f5fbff);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans JP','Hiragino Kaku Gothic ProN',Meiryo,sans-serif;}
  .container{max-width:960px;margin:0 auto;padding:16px 16px 80px;}
  h1{font-size:22px;font-weight:800;margin:8px 0 12px}
  .badge{display:inline-flex;align-items:center;gap:6px;background:#000c;color:#fff;border-radius:999px;padding:6px 10px;font-size:12px}
  .card{background:var(--card);backdrop-filter:blur(8px);border:1px solid var(--border);border-radius:20px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .grow{flex:1}
  .muted{color:var(--muted);font-size:14px}
  .btn{height:46px;padding:0 18px;border-radius:12px;border:0;cursor:pointer;font-weight:800;box-shadow:0 2px 8px rgba(0,0,0,.08)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn-primary{background:var(--blue);color:#fff}
  .btn-dark{background:#111827;color:#fff}
  .btn-ghost{background:#f3f4f6;color:#111827}
  .btn-danger{background:var(--red);color:#fff}
  .btn-next{width:100%}@media(min-width:768px){.btn-next{width:18rem}}
  /* PICK 画面だけ太字を弱める */
  .btn-lite{font-weight:600}
  .grid2{display:grid;grid-template-columns:1fr;gap:12px}@media(min-width:640px){.grid2{grid-template-columns:1fr 1fr}}
  .tile{height:64px;border:1px solid var(--border);border-radius:16px;background:#fafafa;display:grid;place-items:center;font-weight:700}
  .tile.active{border-color:var(--blue);background:#e8f0ff}
  .chip{padding:2px 8px;border-radius:999px;background:var(--blue);color:#fff;font-size:12px;margin-left:8px}
  .q-title{font-size:18px;font-weight:700;line-height:1.5}
  .result{color:#fff;border-radius:16px;padding:12px 14px;font-weight:800}
  .bg-now{background:var(--red)} .bg-strong{background:var(--orange)}
  .bg-day{background:var(--amber)} .bg-self{background:var(--green)}
  .help{font-size:12px;color:#555;background:#fff7d6;border:1px solid #f4e6a7;border-radius:10px;padding:8px}
  footer{font-size:12px;color:#666;margin-top:14px}
  .timer{display:flex;align-items:center;gap:10px}
  .timer .circle{width:42px;height:42px;border-radius:50%;border:4px solid #e5e7eb;position:relative}
  .timer .num{position:absolute;inset:0;display:grid;place-items:center;font-weight:800}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
  .overlay .inner{max-width:560px;width:100%;background:#fff;border-radius:18px;padding:16px;box-shadow:0 10px 32px rgba(0,0,0,.3)}
  a.link{color:#1d4ed8;text-decoration:underline}
  .hidden{display:none!important}
  .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}.mb8{margin-bottom:8px}
  .spacey>*+*{margin-top:12px}
  /* はい/いいえの選択状態（視覚的に残す） */
  .yn-yes-active{background:var(--red);color:#fff}
  .yn-no-active{background:#111827;color:#fff}
  .yn-inactive{background:#f3f4f6;color:#111827}
</style>
</head>
<body>
  <div class="container">
    <header class="row" style="justify-content:space-between">
      <h1>救急要請の再判断アシスト（MVP）</h1>
      <span class="badge">迷ったら #7119</span>
    </header>

    <div class="card spacey" id="app">

      <!-- タイマー行 -->
      <div class="row">
        <div class="row grow" style="align-items:center">
          <div class="timer">
            <div class="circle"><div class="num" id="timerNum">0</div></div>
          </div>
          <div class="muted" id="timerText">「通報するか迷っている」を押すと安全確認タイマーが開始します（自動発信はしません）。</div>
        </div>
        <a class="btn btn-ghost" target="_blank" rel="noopener" href="https://www.fdma.go.jp/mission/enrichment/appropriate/appropriate007.html">#7119（案内）</a>
      </div>

      <!-- 画面：HOME -->
      <div id="view-home" class="spacey">
        <div class="grid2">
          <button class="btn btn-dark" id="btn-start">A. 通報するか迷っている</button>
          <button class="btn btn-danger" id="btn-panic">B. 明らかに緊急（要請を強く検討）</button>
        </div>
        <div>
          <div class="muted mb8">クイック検索（自分の症状向け）</div>
          <div class="row">
            <button class="btn btn-ghost" data-quick="skin">虫に刺された</button>
            <button class="btn btn-ghost" data-quick="fever">発熱</button>
            <button class="btn btn-ghost" data-quick="trauma">外傷/出血</button>
          </div>
        </div>
      </div>

      <!-- 画面：PICK 自分/他者（←ここだけ太字を弱めた） -->
      <div id="view-pick" class="spacey hidden">
        <div class="muted">対象を選んでください。</div>
        <div class="grid2">
          <button class="btn btn-ghost btn-lite" id="btn-self">自分の症状について</button>
          <button class="btn btn-ghost btn-lite" id="btn-other">他者を見つけた／様子がおかしい人がいる</button>
        </div>
      </div>

      <!-- 画面：カテゴリ（自分） -->
      <div id="view-self-cat" class="spacey hidden">
        <div class="muted">最も近い項目を選択（複数可）。優先度は自動で決まります。</div>
        <div id="self-tiles" class="grid2"></div>
        <div class="row" style="justify-content:flex-end">
          <button class="btn btn-ghost" id="back-self-cat">一つ前へ</button>
          <button class="btn btn-primary btn-next" id="next-self-cat" disabled>次へ</button>
        </div>
      </div>

      <!-- 画面：レッド/ボーダー/リスク（自分） -->
      <div id="view-self-q" class="spacey hidden">
        <div class="row" style="align-items:center">
          <div id="self-emoji" style="font-size:28px">❓</div>
          <div>
            <div id="self-label" style="font-weight:800"></div>
            <div class="muted" id="self-subtitle"></div>
          </div>
        </div>
        <div class="spacey">
          <div class="q-title" id="self-qtext"></div>
          <div class="row">
            <button class="btn yn-inactive" id="self-yes">はい</button>
            <button class="btn yn-inactive" id="self-no">いいえ</button>
          </div>
          <div class="muted" style="font-size:12px">※ 「はい」は体調に問題がある／心配な状態を示します。</div>
        </div>
        <div class="row" style="justify-content:space-between">
          <button class="btn btn-ghost" id="self-back">一つ前へ</button>
          <button class="btn btn-primary btn-next" id="self-next">次へ</button>
        </div>
      </div>

      <!-- 画面：カテゴリ（他者） -->
      <div id="view-other-cat" class="spacey hidden">
        <div class="muted">見てわかる状態を選択（複数可）。優先度は自動で決まります。</div>
        <div id="other-tiles" class="grid2"></div>
        <div class="row" style="justify-content:flex-end">
          <button class="btn btn-ghost" id="back-other-cat">一つ前へ</button>
          <button class="btn btn-primary btn-next" id="next-other-cat" disabled>次へ</button>
        </div>
      </div>

      <!-- 画面：レッド/ボーダー/リスク（他者） -->
      <div id="view-other-q" class="spacey hidden">
        <div class="row" style="align-items:center">
          <div id="other-emoji" style="font-size:28px">❓</div>
          <div>
            <div id="other-label" style="font-weight:800"></div>
            <div class="muted" id="other-subtitle"></div>
          </div>
        </div>
        <div class="spacey">
          <div class="q-title" id="other-qtext"></div>
          <div class="row">
            <button class="btn yn-inactive" id="other-yes">はい</button>
            <button class="btn yn-inactive" id="other-no">いいえ</button>
          </div>
          <div class="muted" style="font-size:12px">※ 「はい」は体調に問題がある／心配な状態を示します。</div>
        </div>
        <div class="row" style="justify-content:space-between">
          <button class="btn btn-ghost" id="other-back">一つ前へ</button>
          <button class="btn btn-primary btn-next" id="other-next">次へ</button>
        </div>
      </div>

      <!-- 画面：結果 -->
      <div id="view-result" class="spacey hidden">
        <div id="result-box" class="result">判定</div>
        <div class="help">
          <b>免責：</b>本サイトは救急要請の「再判断」を支援する一般情報です。診断・治療の指示は行いません。迷ったら #7119 等の公的窓口を利用してください。
        </div>
        <div id="consult" class="spacey">
          <div class="muted">自力受診・相談の公的導線</div>
          <div class="row">
            <a class="btn btn-ghost" target="_blank" rel="noopener" href="https://www.tfd.metro.tokyo.lg.jp/hp-kyuuimuka/guide/main/index.html">東京版 救急受診ガイド</a>
            <a class="btn btn-ghost" target="_blank" rel="noopener" href="https://www.fdma.go.jp/mission/enrichment/appropriate/appropriate007.html">#7119（制度解説）</a>
            <a class="btn btn-ghost" target="_blank" rel="noopener" href="https://www.tfd.metro.tokyo.lg.jp/lfe/kyuu_adv/soudan-center.html">東京消防庁 #7119</a>
          </div>
        </div>
        <div class="row" style="justify-content:flex-end">
          <button class="btn btn-ghost" id="to-top">トップへ戻る</button>
        </div>
      </div>

    </div>

    <footer>
      本サイトは救急要請の「再判断」を支援する一般情報です。診断・治療の指示は行いません。迷ったら #7119 等の公的窓口を利用してください。
      <div class="row mt8"><a class="link" href="#terms" id="link-terms">利用規約</a><a class="link" href="#privacy" id="link-privacy">プライバシーポリシー</a></div>
    </footer>
  </div>

  <!-- タイムアウト・オーバーレイ -->
  <div class="overlay" id="overlay">
    <div class="inner spacey">
      <div class="result bg-now">安全確認タイマーが0秒になりました</div>
      <div>迷う場合は<strong>安全側</strong>に倒してください。<br>症状が続く/悪化の可能性があります。<strong>緊急に要請を強く検討してください。</strong></div>
      <div class="row">
        <button class="btn btn-primary btn-next" id="ov-call">緊急に要請を強く検討する</button>
        <button class="btn btn-dark btn-next" id="ov-back">状態記入の質問に戻る</button>
      </div>
      <div class="muted">※ 判断に迷う場合は <a class="link" target="_blank" rel="noopener" href="https://www.fdma.go.jp/mission/enrichment/appropriate/appropriate007.html">#7119（救急安心センター）</a> へ。</div>
    </div>
  </div>

<script>
/* ========= データ定義 ========= */
const PRIORITY_SELF = ["conscious","stroke","cardioresp","trauma","fever","skin"];
const SELF = [
  {key:"conscious", label:"意識がおかしい/けいれん", emoji:"🧠",
    red:{id:"co_rf", text:"呼びかけに反応がない、または けいれんが続く/5分以上/何度も起きていますか？"},
    border:[{id:"co_head", text:"頭をぶつけた後、吐く/ぼんやりする/様子がおかしいですか？"}],
    risk:[{id:"co_blood", text:"血をさらさらにする薬（抗凝固・抗血小板）を飲んでいますか？"}],
    decide:(a,r)=> a.co_rf ? "CALL_NOW" : (a.co_head||r>0) ? "CALL_STRONGLY" : "SAME_DAY"
  },
  {key:"stroke", label:"片側の手足が動かしにくい/ろれつが回らない", emoji:"🫥",
    red:{id:"s_rf", text:"顔のゆがみ/片腕が上がらない/うまく話せない（いずれか）ですか？"},
    border:[{id:"s_bal", text:"ふらついて歩けない/バランスが取れないですか？"},{id:"s_vis", text:"片目が見えにくい/二重に見えるなど見え方の変化がありますか？"}],
    risk:[{id:"s_time", text:"発症が4.5時間以内の可能性がありますか？（はっきりしない場合も「はい」）"}],
    decide:(a,r)=> a.s_rf ? "CALL_NOW" : (a.s_bal||a.s_vis) ? (r>0?"CALL_STRONGLY":"SAME_DAY") : "SAME_DAY"
  },
  {key:"cardioresp", label:"胸の痛み/息苦しさ", emoji:"❤️‍🔥",
    red:{id:"cr_rf", text:"圧迫/締め付け胸痛が10分以上続く、または 一息で話せない/くちびるが青い ですか？"},
    border:[{id:"cr_rad", text:"痛みが あご/肩/背中/腕 に広がっていますか？"},{id:"cr_aut", text:"冷や汗/吐き気がありますか？"},{id:"cr_wheeze", text:"ぜいぜいが強く、休んでも良くなりにくいですか？"}],
    risk:[{id:"cr_risk", text:"心臓・肺の病気の通院中/糖尿病/高齢など、心配な条件が複数ありますか？"}],
    decide:(a,r,mins)=> a.cr_rf ? "CALL_NOW" : (a.cr_rad||a.cr_aut||a.cr_wheeze||r>0) ? "CALL_STRONGLY" : (mins>=20?"CALL_STRONGLY":"SAME_DAY")
  },
  {key:"trauma", label:"外傷/出血", emoji:"🩸",
    red:{id:"t_rf", text:"強く押さえても血が止まらない、または 高い所からの転落/交通事故などがありましたか？"},
    border:[{id:"t_headhit", text:"頭をぶつけましたか？"},{id:"t_symp", text:"その後、吐く/頭痛が悪化/ぼんやり/様子の変化がありますか？"}],
    risk:[{id:"t_blood", text:"血をさらさらにする薬を飲んでいる/65歳以上ですか？"}],
    decide:(a,r)=> a.t_rf ? "CALL_NOW" : (a.t_headhit && (a.t_symp||r>0)) ? "CALL_STRONGLY" : "SAME_DAY"
  },
  {key:"fever", label:"発熱＋ぐったり/水分がとれない", emoji:"🌡️",
    red:{id:"f_rf", text:"強い眠気/混乱、または 呼吸が速い/息苦しい ですか？"},
    border:[{id:"f_poor", text:"ほとんど水分がとれない/おしっこが極端に少ないですか？"},{id:"f_persist", text:"高い熱が続く/悪くなってきていますか？"}],
    risk:[{id:"f_worry", text:"高齢/妊娠中/免疫が弱い/透析など、心配な条件に当てはまりますか？"}],
    decide:(a,r)=> (a.f_rf||r>0) ? "CALL_STRONGLY" : (a.f_poor||a.f_persist) ? "SAME_DAY" : "SELF_CARE"
  },
  {key:"skin", label:"皮ふのはれ・虫さされ・全身の強い反応", emoji:"🦟",
    red:{id:"sk_rf", text:"息苦しさ/声がれ/のどのはれ＋顔のはれ/じんましん など全身に出ていますか？"},
    border:[{id:"sk_spread", text:"さされ/接触後、はれが すぐ広がっていますか？"},{id:"sk_sizepain", text:"はれが大きい（3cm以上目安）または強い痛みがありますか？"},{id:"sk_tick", text:"マダニが食い込んで取れませんか？（自分で抜かない）"}],
    risk:[{id:"sk_worry", text:"小児/高齢/妊娠中/呼吸の病気/強いアレルギーの経験がありますか？"},{id:"sk_remote", text:"病院まで1時間以上かかる場所ですか？"}],
    decide:(a,r)=> a.sk_rf ? "CALL_NOW" : (a.sk_spread||a.sk_sizepain||(r>0&&(a.sk_spread||a.sk_sizepain))) ? "CALL_STRONGLY" : a.sk_tick ? "SAME_DAY" : (!a.sk_spread&&!a.sk_sizepain&&!a.sk_tick) ? "SELF_CARE" : "SAME_DAY"
  }
];

const PRIORITY_OTHER = ["other_conscious","other_stroke","other_cardioresp","other_trauma","other_allergy","other_fever"];
const OTHER = [
  {key:"other_conscious", label:"反応がない/けいれん（観察）", emoji:"🧠",
    red:{id:"o_co_rf", text:"呼びかけに反応がない、または けいれんが続く/5分以上/何度も起きていますか？"},
    border:[{id:"o_co_head", text:"頭をぶつけた後、吐く/ぼんやり/様子がおかしいように見えますか？"}],
    risk:[{id:"o_co_worry", text:"高齢/小児/妊娠中/血をさらさらにする薬/持病ありに見えますか？"}],
    decide:(a,r)=> a.o_co_rf ? "CALL_NOW" : (a.o_co_head||r>0) ? "CALL_STRONGLY" : "SAME_DAY"
  },
  {key:"other_stroke", label:"片側が動かしにくい/ろれつ不明瞭（観察）", emoji:"🫥",
    red:{id:"o_s_rf", text:"顔のゆがみ/片腕が上がらない/話し方がおかしい（いずれか）ですか？"},
    border:[{id:"o_s_bal", text:"ふらついて歩けない/バランスが悪い様子ですか？"},{id:"o_s_vis", text:"片目が見えにくい/二重に見える様子ですか？"}],
    risk:[{id:"o_s_time", text:"起きたのが4.5時間以内らしい/その可能性が高いですか？"}],
    decide:(a,r)=> a.o_s_rf ? "CALL_NOW" : (a.o_s_bal||a.o_s_vis) ? (r>0?"CALL_STRONGLY":"SAME_DAY") : "SAME_DAY"
  },
  {key:"other_cardioresp", label:"息苦しさ/胸を押さえる（観察）", emoji:"❤️‍🔥",
    red:{id:"o_cr_rf", text:"一息で話せないほど息苦しい/くちびるが青い様子ですか？"},
    border:[{id:"o_cr_pain", text:"胸を押さえる/苦しそう/冷や汗・吐き気の様子ですか？"},{id:"o_cr_wheeze", text:"ぜいぜいが強く、休ませても楽にならない様子ですか？"}],
    risk:[{id:"o_cr_worry", text:"高齢/持病ありに見えますか？"}],
    decide:(a,r)=> a.o_cr_rf ? "CALL_NOW" : (a.o_cr_pain||a.o_cr_wheeze||r>0) ? "CALL_STRONGLY" : "SAME_DAY"
  },
  {key:"other_trauma", label:"大きな出血/強いけが（観察）", emoji:"🩸",
    red:{id:"o_t_rf", text:"強く押さえても出血が止まらない、または 高い所から落ちた/交通事故などがありましたか？"},
    border:[{id:"o_t_head", text:"頭をぶつけたように見えますか？"},{id:"o_t_post", text:"その後、吐く/頭痛が悪化/ぼんやり/様子が変ですか？"}],
    risk:[{id:"o_t_worry", text:"高齢/血をさらさらにする薬を飲んでいそうですか？（わかる範囲で）"}],
    decide:(a,r)=> a.o_t_rf ? "CALL_NOW" : (a.o_t_head&&(a.o_t_post||r>0)) ? "CALL_STRONGLY" : "SAME_DAY"
  },
  {key:"other_allergy", label:"顔のはれ/じんましん＋息苦しさ（観察）", emoji:"🦟",
    red:{id:"o_a_rf", text:"息苦しさ/声がれ/のどのはれ＋顔のはれ/じんましん など全身に出ていますか？"},
    border:[{id:"o_a_spread", text:"さされ/接触後、はれがすぐ広がっている様子ですか？"},{id:"o_a_sizepain", text:"はれが大きい（3cm以上目安）または強い痛みがありそうですか？"}],
    risk:[{id:"o_a_history", text:"以前に強いアレルギー反応を起こしたことがあると聞きましたか？"}],
    decide:(a,r)=> a.o_a_rf ? "CALL_NOW" : (a.o_a_spread||a.o_a_sizepain||r>0) ? "CALL_STRONGLY" : "SAME_DAY"
  },
  {key:"other_fever", label:"ぐったり/発熱（観察）", emoji:"🌡️",
    red:{id:"o_f_rf", text:"強い混乱/ねむけ、または 呼吸が速い/息苦しそう ですか？"},
    border:[{id:"o_f_leth", text:"ぐったりして、水分がとれていない様子ですか？"},{id:"o_f_persist", text:"高い熱が続き、悪化している様子ですか？"}],
    risk:[{id:"o_f_worry", text:"高齢/小児/妊娠中/免疫が弱い などに見えますか？"}],
    decide:(a,r)=> (a.o_f_rf||r>0) ? "CALL_STRONGLY" : (a.o_f_leth||a.o_f_persist) ? "SAME_DAY" : "SELF_CARE"
  }
];

const CAT_LABEL = {
  CALL_NOW:{title:"① いま救急要請が必要な可能性が高い", color:"bg-now", reason:"重大な可能性があります。至急、救急要請を検討してください。"},
  CALL_STRONGLY:{title:"② 救急要請を強く検討", color:"bg-strong", reason:"重い病気や悪化の兆候が複数あります。救急要請の検討を強くおすすめします。"},
  SAME_DAY:{title:"③ 本日中に受診", color:"bg-day", reason:"緊急性は高くない可能性があります。本日中の受診をおすすめします。"},
  SELF_CARE:{title:"④ 自己ケア＋再評価", color:"bg-self", reason:"自己ケアで経過観察可能な見込みです。"}
};

/* ========= 状態 ========= */
let route="HOME";            // HOME, PICK, SELF_CAT, SELF_Q, OTHER_CAT, OTHER_Q, RESULT
let who="SELF";              // SELF or OTHER
let timerActive=false, timerMax=30, timerCount=0, timerId=null;
let startAt=null;            // 経過分判定用
let selections=new Set();    // 選択カテゴリ
let focusKey=null;           // 現在の主カテゴリ
let step="RED";              // RED, BORDER, RISK
let idx=0;                   // 質問インデックス
let answers={};              // 回答マップ
let resultCat="CALL_NOW";

/* ========= ユーティリティ ========= */
const $=sel=>document.querySelector(sel);
const show=(id,flag)=>{ const el=$(id); if(!el)return; el.classList.toggle('hidden', !flag); };
function setTimer(active,max){
  clearInterval(timerId); timerActive=active; timerMax=max; timerCount=max;
  $('#timerNum').textContent=active?timerCount:0;
  $('#timerText').textContent=active? '安全確認タイマー作動中。0で緊急案内が出ます。' :
    '「通報するか迷っている」を押すと安全確認タイマーが開始します（自動発信はしません）。';
  if(!active) return;
  timerId=setInterval(()=>{
    timerCount--; $('#timerNum').textContent=timerCount;
    if(timerCount<=0){ clearInterval(timerId); timerActive=false; $('#overlay').style.display='flex'; }
  },1000);
}
function resetFlow(){
  selections.clear(); focusKey=null; step="RED"; idx=0; answers={};
}
function getList(){ return who==="SELF"?SELF:OTHER; }
function getPriority(){ return who==="SELF"?PRIORITY_SELF:PRIORITY_OTHER; }
function pickFocus(){
  for(const k of getPriority()){ if(selections.has(k)){ focusKey=k; return; } }
  focusKey=[...selections][0]||null;
}
function minutesPersisted(){ if(!startAt) return 0; return Math.max(0, Math.round((Date.now()-startAt)/60000)); }

/* ========= 画面描画 ========= */
function render(){
  // すべて隠す
  ['#view-home','#view-pick','#view-self-cat','#view-self-q','#view-other-cat','#view-other-q','#view-result']
    .forEach(id=>show(id,false));
  if(route==='HOME'){ show('#view-home',true); return; }
  if(route==='PICK'){ show('#view-pick',true); return; }
  if(route==='SELF_CAT'){
    buildTiles('#self-tiles', SELF);
    $('#next-self-cat').disabled=!focusKey;
    show('#view-self-cat',true); return;
  }
  if(route==='SELF_Q'){ buildQuestion('SELF'); show('#view-self-q',true); return; }
  if(route==='OTHER_CAT'){
    buildTiles('#other-tiles', OTHER);
    $('#next-other-cat').disabled=!focusKey;
    show('#view-other-cat',true); return;
  }
  if(route==='OTHER_Q'){ buildQuestion('OTHER'); show('#view-other-q',true); return; }
  if(route==='RESULT'){ buildResult(); show('#view-result',true); return; }
}

function buildTiles(containerSel, data){
  const el=$(containerSel); el.innerHTML='';
  for(const s of data){
    const btn=document.createElement('button');
    btn.className='tile'+(selections.has(s.key)?' active':'');
    btn.innerHTML=`<span style="font-size:20px;margin-right:8px">${s.emoji}</span>${s.label}`+(focusKey===s.key?`<span class="chip">優先</span>`:'');
    btn.onclick=()=>{
      if(selections.has(s.key)) selections.delete(s.key); else selections.add(s.key);
      pickFocus(); render();
    };
    el.appendChild(btn);
  }
}

function currentSymptom(){
  const list=getList();
  return list.find(s=>s.key===focusKey);
}

function updateYNStyles(side){
  const cfg=currentSymptom(); if(!cfg) return;
  const prefix = (side==='SELF'?'self':'other');
  let v;
  if(step==='RED'){ v = answers[cfg.red.id]; }
  else{
    const qset = step==='BORDER' ? cfg.border : cfg.risk;
    v = answers[qset[idx]?.id];
  }
  const yesBtn = $('#'+prefix+'-yes');
  const noBtn  = $('#'+prefix+'-no');
  yesBtn.className = 'btn ' + (v===true  ? 'yn-yes-active' : 'yn-inactive');
  noBtn.className  = 'btn ' + (v===false ? 'yn-no-active'  : 'yn-inactive');
}

function buildQuestion(side){
  const cfg=currentSymptom();
  $('#'+(side==='SELF'?'self':'other')+'-emoji').textContent=cfg.emoji;
  $('#'+(side==='SELF'?'self':'other')+'-label').textContent=cfg.label;

  const qset = step==='RED' ? [cfg.red] : step==='BORDER' ? cfg.border : cfg.risk;
  const subtitle = step==='RED' ? 'まず最初に確認（「はい」は問題あり）'
                  : step==='BORDER' ? `もう少し確認（${idx+1}/${qset.length}）`
                  : `気をつける条件の確認（${idx+1}/${qset.length}）`;
  $('#'+(side==='SELF'?'self':'other')+'-subtitle').textContent=subtitle;

  const q = (step==='RED') ? cfg.red : qset[idx];
  $('#'+(side==='SELF'?'self':'other')+'-qtext').textContent=q.text;

  updateYNStyles(side);
}

function buildResult(){
  const meta=CAT_LABEL[resultCat];
  const box=$('#result-box');
  box.className='result '+meta.color;
  box.textContent=meta.title+' — '+meta.reason;
  $('#consult').style.display = (resultCat==='SAME_DAY' || resultCat==='SELF_CARE') ? 'block':'none';
}

/* ========= 初期イベント ========= */
document.getElementById('btn-start').onclick=()=>{ route='PICK'; setTimer(true,30); startAt=Date.now(); render(); };
document.getElementById('btn-panic').onclick=()=>{ route='RESULT'; resultCat='CALL_NOW'; setTimer(false,0); render(); };
document.querySelectorAll('[data-quick]').forEach(b=>{
  b.onclick=()=>{
    who='SELF'; resetFlow(); selections.add(b.dataset.quick); pickFocus();
    route='SELF_CAT'; setTimer(true,30); startAt=Date.now(); render();
  };
});
document.getElementById('btn-self').onclick=()=>{ who='SELF'; resetFlow(); route='SELF_CAT'; setTimer(true,30); render(); };
document.getElementById('btn-other').onclick=()=>{ who='OTHER'; resetFlow(); route='OTHER_CAT'; setTimer(true,30); render(); };

/* 自分カテゴリ */
document.getElementById('back-self-cat').onclick=()=>{ route='PICK'; setTimer(true,30); render(); };
document.getElementById('next-self-cat').onclick=()=>{ if(!focusKey)return; route='SELF_Q'; step='RED'; idx=0; setTimer(true,10); render(); };

/* 他者カテゴリ */
document.getElementById('back-other-cat').onclick=()=>{ route='PICK'; setTimer(true,30); render(); };
document.getElementById('next-other-cat').onclick=()=>{ if(!focusKey)return; route='OTHER_Q'; step='RED'; idx=0; setTimer(true,10); render(); };

/* 自分：質問 */
document.getElementById('self-yes').onclick=()=>{ handleAnswer(true,'SELF'); };
document.getElementById('self-no').onclick=()=>{ handleAnswer(false,'SELF'); };
document.getElementById('self-back').onclick=()=>{ goBack('SELF'); };
document.getElementById('self-next').onclick=()=>{ goNext('SELF'); };

/* 他者：質問 */
document.getElementById('other-yes').onclick=()=>{ handleAnswer(true,'OTHER'); };
document.getElementById('other-no').onclick=()=>{ handleAnswer(false,'OTHER'); };
document.getElementById('other-back').onclick=()=>{ goBack('OTHER'); };
document.getElementById('other-next').onclick=()=>{ goNext('OTHER'); };

/* 結果 */
document.getElementById('to-top').onclick=()=>{ route='HOME'; setTimer(false,0); render(); };

/* オーバーレイ */
document.getElementById('ov-call').onclick=()=>{ document.getElementById('overlay').style.display='none'; route='RESULT'; resultCat='CALL_NOW'; render(); };
document.getElementById('ov-back').onclick=()=>{ document.getElementById('overlay').style.display='none';
  setTimer(true,10); render();
};

/* 質問回答処理（選択状態の見た目を保持） */
function handleAnswer(val, side){
  const cfg=currentSymptom();
  if(step==='RED'){ answers[cfg.red.id]=val; }
  else{
    const qset = step==='BORDER' ? cfg.border : cfg.risk;
    answers[qset[idx].id]=val;
  }
  updateYNStyles(side);
}

function goNext(side){
  const cfg=currentSymptom();
  const mins = minutesPersisted();
  if(step==='RED'){
    if(answers[cfg.red.id]===true){ resultCat='CALL_NOW'; route='RESULT'; setTimer(false,0); render(); return; }
    if(cfg.border.length){ step='BORDER'; idx=0; setTimer(true,10); render(); return; }
    if(cfg.risk.length){ step='RISK'; idx=0; setTimer(true,10); render(); return; }
    const rYes = cfg.risk.reduce((n,q)=> n + (answers[q.id]?1:0), 0);
    resultCat = cfg.decide(answers, rYes, mins);
    route='RESULT'; setTimer(false,0); render(); return;
  }
  if(step==='BORDER'){
    if(idx < cfg.border.length-1){ idx++; setTimer(true,10); render(); return; }
    if(cfg.risk.length){ step='RISK'; idx=0; setTimer(true,10); render(); return; }
    const rYes = 0;
    resultCat = cfg.decide(answers, rYes, mins);
    route='RESULT'; setTimer(false,0); render(); return;
  }
  if(step==='RISK'){
    if(idx < cfg.risk.length-1){ idx++; setTimer(true,10); render(); return; }
    const rYes = cfg.risk.reduce((n,q)=> n + (answers[q.id]?1:0), 0);
    resultCat = cfg.decide(answers, rYes, mins);
    route='RESULT'; setTimer(false,0); render(); return;
  }
}

function goBack(side){
  if(step==='RED'){ route = (side==='SELF'?'SELF_CAT':'OTHER_CAT'); setTimer(true,30); render(); return; }
  if(step==='BORDER'){
    if(idx>0){ idx--; setTimer(true,10); render(); return; }
    step='RED'; setTimer(true,10); render(); return;
  }
  if(step==='RISK'){
    if(idx>0){ idx--; setTimer(true,10); render(); return; }
    step='BORDER'; setTimer(true,10); render(); return;
  }
}

/* 利用規約/プライバシーの簡易遷移（同一ページ） */
document.getElementById('link-terms').onclick=(e)=>{ e.preventDefault(); alert("【利用規約】\n本サービスは救急要請の『再判断』を支援する一般情報です。診断・治療の指示は行いません。ご利用により生じた損害について、法令で認められる範囲で責任を負いません。"); };
document.getElementById('link-privacy').onclick=(e)=>{ e.preventDefault(); alert("【プライバシーポリシー】\n個人情報をサーバ保存しません。アクセス解析も現時点で行いません。今後導入時は同意を得ます。"); };

/* 初期表示 */
render();
</script>
</body>
</html>
