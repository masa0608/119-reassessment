<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>救急要請の再判断アシスト（自分/他者対応・MVP）</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Tailwind（CDN） -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React 18 & Babel（CDN） -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <meta name="color-scheme" content="light only" />
    <style>
      body { -webkit-font-smoothing: antialiased; }
      .prose h2 { font-size: 1.125rem; margin-top: 1.25rem; margin-bottom: .5rem; }
      .prose p, .prose li { line-height: 1.8; }
    </style>
  </head>
  <body class="min-h-screen">
    <div id="root"></div>

    <script type="text/babel" data-presets="env,react">
      const { useEffect, useMemo, useState } = React;

      // ====== 簡易ルーター（#/ , #/terms , #/privacy） ======
      function useHashRoute() {
        const parse = () => (location.hash.replace(/^#/, "") || "/");
        const [route, setRoute] = useState(parse());
        useEffect(() => {
          const onHash = () => setRoute(parse());
          window.addEventListener("hashchange", onHash);
          return () => window.removeEventListener("hashchange", onHash);
        }, []);
        const navigate = (r) => { location.hash = r; };
        return [route, navigate];
      }

      // ====== 公的導線（確認済URL） ======
      const LINKS = {
        GUIDE_TOKYO: "https://www.tfd.metro.tokyo.lg.jp/hp-kyuuimuka/guide/main/index.html",
        ABOUT_7119: "https://www.fdma.go.jp/mission/enrichment/appropriate/appropriate007.html",
        TOKYO_7119: "https://www.tfd.metro.tokyo.lg.jp/lfe/kyuu_adv/soudan-center.html",
        TEL_7119_TEXT: "#7119（救急安心センターの案内）",
      };

      const CAT_LABEL = {
        CALL_NOW:      { title: "① いま救急要請が必要な可能性が高い", color: "bg-red-600" },
        CALL_STRONGLY: { title: "② 救急要請を強く検討",             color: "bg-orange-500" },
        SAME_DAY:      { title: "③ 本日中に受診",                     color: "bg-amber-500" },
        SELF_CARE:     { title: "④ 自己ケア＋再評価",                 color: "bg-emerald-600" },
      };

      // ====== UIパーツ ======
      const SolidBtn = ({ className = "", children, ...rest }) => (
        <button {...rest} className={"h-14 rounded-2xl font-bold shadow-lg active:scale-[0.99] " + className}>
          {children}
        </button>
      );

      const CircleTimer = ({ seconds, total, colorClass }) => {
        const r = 26, c = 2 * Math.PI * r;
        const prog = Math.max(0, Math.min(1, seconds / total));
        const dash = c * prog;
        return (
          <svg viewBox="0 0 64 64" className="w-10 h-10" role="img" aria-label={`安全確認タイマー 残り${seconds}秒`}>
            <circle cx="32" cy="32" r={r} className="fill-none stroke-neutral-200" strokeWidth="6" />
            <circle cx="32" cy="32" r={r} className={"fill-none " + (colorClass || "stroke-blue-600")} strokeWidth="6"
                    strokeDasharray={`${dash} ${c}`} strokeLinecap="round" transform="rotate(-90 32 32)" />
            <text x="50%" y="52%" textAnchor="middle" className="fill-neutral-800 text-[14px] font-bold">{seconds}</text>
          </svg>
        );
      };

      const YesNo = ({ q, value, onAnswer }) => (
        <div className="space-y-3">
          <div className="text-lg font-semibold leading-relaxed">{q.text}</div>
          <div className="grid grid-cols-2 gap-3">
            <button aria-label="はい（問題あり）"
              className={"h-14 rounded-2xl font-bold text-lg shadow " + (value === true ? "bg-red-600 text-white" : "bg-red-50 text-red-700")}
              onClick={() => onAnswer(true)}>はい</button>
            <button aria-label="いいえ（問題なし）"
              className={"h-14 rounded-2xl font-bold text-lg shadow " + (value === false ? "bg-neutral-800 text-white" : "bg-neutral-100 text-neutral-900")}
              onClick={() => onAnswer(false)}>いいえ</button>
          </div>
        </div>
      );

      function TimeoutOverlay({ onCallNow, onBackToQuestions }) {
        return (
          <div className="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-label="タイムアウトのお知らせ">
            <div className="w-full max-w-lg rounded-2xl bg-white shadow-2xl p-6 space-y-4">
              <div className="rounded-xl p-4 text-white bg-red-600">
                <div className="text-lg font-extrabold">安全確認タイマーが0秒になりました</div>
                <p className="text-sm opacity-90 mt-1">
                  迷う場合は<strong>安全側</strong>に倒してください。<br/>
                  <strong>緊急に要請を強く検討してください。</strong>（症状の悪化や持続が疑われます）
                </p>
              </div>
              <div className="grid gap-3 sm:grid-cols-2">
                <button onClick={onCallNow} className="h-12 rounded-xl bg-red-600 text-white font-bold">緊急に要請を強く検討する</button>
                <button onClick={onBackToQuestions} className="h-12 rounded-xl bg-neutral-800 text-white font-bold">状態記入の質問に戻る</button>
              </div>
              <div className="text-xs text-neutral-600">
                ※ 判断に迷う場合は <a className="underline" href={LINKS.ABOUT_7119} target="_blank" rel="noopener noreferrer">#7119（救急安心センター）</a> へ相談可能です。
              </div>
            </div>
          </div>
        );
      }

      const ResultBlock = ({ category, consultLinks }) => {
        const meta = CAT_LABEL[category];
        const advice = (() => {
          switch (category) {
            case "CALL_NOW":      return { reason: "重大な可能性があります。至急、救急要請を検討してください。", caveat: "迷う場合は#7119（救急安心センター）へ相談可。" };
            case "CALL_STRONGLY": return { reason: "重い病気や悪化の兆候が複数あります。救急要請の検討を強くおすすめします。", caveat: "変化があれば直ちに上位へ。" };
            case "SAME_DAY":      return { reason: "緊急性は高くない可能性があります。本日中の受診をおすすめします。", caveat: "悪化・持続・新症状で救急要請を再検討。" };
            case "SELF_CARE":     return { reason: "自己ケアで経過観察可能な見込みです。", caveat: "不安や悪化時は同日受診→救急要請の順で繰り上げ。" };
            default:              return { reason: "", caveat: "" };
          }
        })();

        return (
          <div className="space-y-6">
            <div className={"rounded-2xl p-4 text-white " + meta.color}>
              <div className="text-lg font-extrabold">{meta.title}</div>
              <div className="text-sm opacity-90 mt-1">{advice.reason}</div>
            </div>

            <div className="rounded-xl border p-3 text-xs leading-relaxed bg-amber-50">
              <strong>免責：</strong>本サイトは救急要請の「再判断」を支援する一般情報です。診断・治療の指示は行いません。迷ったら #7119 等の公的窓口を利用してください。
            </div>

            {consultLinks && (
              <div className="rounded-xl border p-3 space-y-2">
                <div className="font-semibold text-sm">自力受診・相談の公的導線</div>
                <div className="grid gap-2 sm:grid-cols-3">
                  <a className="h-12 grid place-items-center rounded-xl bg-neutral-100 hover:bg-neutral-200 text-sm font-semibold"
                     href={LINKS.GUIDE_TOKYO} target="_blank" rel="noopener noreferrer" aria-label="東京版 救急受診ガイドを開く">
                    東京版 救急受診ガイド
                  </a>
                  <a className="h-12 grid place-items-center rounded-xl bg-neutral-100 hover:bg-neutral-200 text-sm font-semibold"
                     href={LINKS.ABOUT_7119} target="_blank" rel="noopener noreferrer" aria-label="#7119 制度解説を開く">
                    {LINKS.TEL_7119_TEXT}
                  </a>
                  <a className="h-12 grid place-items-center rounded-xl bg-neutral-100 hover:bg-neutral-200 text-sm font-semibold"
                     href={LINKS.TOKYO_7119} target="_blank" rel="noopener noreferrer" aria-label="東京消防庁 救急相談センターを開く">
                    東京消防庁 #7119（電話で相談）
                  </a>
                </div>
                <div className="text-xs text-neutral-600">※ 地域で窓口が異なる場合あり。お住まいの自治体案内に合わせてください。</div>
              </div>
            )}

            <div className="rounded-xl border p-3 text-xs text-neutral-600">
              <div className="font-semibold mb-1">注記</div>
              <div>{advice.caveat}</div>
            </div>
          </div>
        );
      };

      // ====== 自分の症状：カテゴリ定義（変更なし） ======
      const PRIORITY_ORDER = ["conscious", "stroke", "cardioresp", "trauma", "fever", "skin"];
      const SELF_SYMPTOMS = [
        {
          key: "conscious",
          label: "意識がおかしい/けいれん",
          emoji: "🧠",
          priority: 1,
          redFlag: { id: "co_rf", text: "呼びかけに反応しない、または けいれんが5分以上続く/反復していますか？" },
          borderline: [{ id: "co_head", text: "頭部外傷（転倒等）があり、その後に悪化/嘔吐/行動異常がありますか？" }],
          risk: [{ id: "co_anticoag", text: "抗凝固/抗血小板薬を服用していますか？" }],
          decide: (a, rYes) => (a["co_rf"] ? "CALL_NOW" : (a["co_head"] || rYes > 0) ? "CALL_STRONGLY" : "SAME_DAY"),
        },
        {
          key: "stroke",
          label: "片麻痺/ろれつがおかしい",
          emoji: "🫥",
          priority: 2,
          redFlag: { id: "s_rf", text: "顔のゆがみ/片腕の脱力/言葉の障害（いずれか）がありますか？（BE-FAST）" },
          borderline: [
            { id: "s_bal", text: "ふらつき・歩行不能・バランスが取れない？" },
            { id: "s_vis", text: "視野が欠ける/二重に見える/片目が見えにくい？" },
          ],
          risk: [{ id: "s_time", text: "発症から4.5時間以内の可能性がある" }],
          decide: (a, rYes) => (a["s_rf"] ? "CALL_NOW" : (a["s_bal"] || a["s_vis"]) ? (rYes > 0 ? "CALL_STRONGLY" : "SAME_DAY") : "SAME_DAY"),
        },
        {
          key: "cardioresp",
          label: "胸の痛み/息苦しさ",
          emoji: "❤️‍🔥",
          priority: 3,
          redFlag: { id: "cr_rf", text: "圧迫/締め付け胸痛が10分以上、または 一息で話せない/口唇が青い（チアノーゼ）ですか？" },
          borderline: [
            { id: "cr_rad", text: "顎/肩/背中/腕に痛みが広がる（放散痛）？" },
            { id: "cr_aut", text: "冷汗/吐き気がある？" },
            { id: "cr_wheeze", text: "ぜいぜいが強い/吸入で改善が乏しい？" },
          ],
          risk: [{ id: "cr_risk", text: "心肺疾患の既往・糖尿病・高齢など（2項目以上）" }],
          decide: (a, rYes, minutes) => {
            if (a["cr_rf"]) return "CALL_NOW";
            if (a["cr_rad"] || a["cr_aut"] || a["cr_wheeze"] || rYes > 0) return "CALL_STRONGLY";
            return minutes >= 20 ? "CALL_STRONGLY" : "SAME_DAY";
          },
        },
        {
          key: "trauma",
          label: "外傷/出血",
          emoji: "🩸",
          priority: 4,
          redFlag: { id: "t_rf", text: "圧迫しても止まらない出血、または 高所落下/交通事故など強い外力がありましたか？" },
          borderline: [
            { id: "t_headhit", text: "頭を打ちましたか？（転倒・頭部打撲）" },
            { id: "t_symp", text: "その後に嘔吐/頭痛増悪/ぼんやり/行動の変化がありますか？" },
          ],
          risk: [
            { id: "t_anticoag", text: "抗凝固/抗血小板薬を服用している" },
            { id: "t_age65", text: "年齢が65歳以上である" },
          ],
          decide: (a, rYes, _min, age65plus) => {
            if (a["t_rf"]) return "CALL_NOW";
            if (a["t_headhit"] && (a["t_symp"] || rYes > 0 || age65plus)) return "CALL_STRONGLY";
            return "SAME_DAY";
          },
        },
        {
          key: "fever",
          label: "発熱＋ぐったり/脱水",
          emoji: "🌡️",
          priority: 5,
          redFlag: { id: "f_rf", text: "強い眠気/混乱、または 呼吸が速い/息苦しいですか？" },
          borderline: [
            { id: "f_poor", text: "水分がほとんど取れない/尿が極端に少ない？" },
            { id: "f_persist", text: "高熱が続く/悪化している？" },
          ],
          risk: [{ id: "f_risk", text: "高齢/妊娠/免疫抑制/透析などの危険因子" }],
          decide: (a, rYes) => (a["f_rf"] || rYes > 0 ? "CALL_STRONGLY" : (a["f_poor"] || a["f_persist"]) ? "SAME_DAY" : "SELF_CARE"),
        },
        {
          key: "skin",
          label: "皮膚・アレルギー/虫刺され",
          emoji: "🦟",
          priority: 6,
          redFlag: { id: "sk_rf", text: "息苦しさ/声がれ/喉の腫れ、意識がもうろう・冷汗・脈が弱い、口/喉/目の刺傷、同時に多数ヶ所を刺された" },
          borderline: [
            { id: "sk_spread",  text: "刺傷後〜数時間で腫れが急速に広がっている" },
            { id: "sk_history", text: "過去にハチ等で重い反応を起こしたことがある" },
            { id: "sk_sizepain", text: "腫れが3cm以上に広がる、または強い痛みがある" },
            { id: "sk_tick",    text: "マダニが皮膚に食い込んで離れない（自力で抜かない）" }
          ],
          risk: [
            { id: "sk_vuln",   text: "小児/高齢/妊娠/呼吸器疾患/重いアレルギー歴がある" },
            { id: "sk_remote", text: "受診まで1時間以上かかる地域" }
          ],
          decide: (a, rYes) => {
            if (a["sk_rf"]) return "CALL_NOW";
            if (a["sk_spread"] || a["sk_history"] || (rYes > 0 && (a["sk_spread"] || a["sk_sizepain"]))) return "CALL_STRONGLY";
            if (a["sk_tick"]) return "SAME_DAY";
            if (!a["sk_spread"] && !a["sk_sizepain"] && !a["sk_tick"]) return "SELF_CARE";
            return "SAME_DAY";
          }
        },
      ];

      // ====== 他者観察フロー（Yes=問題あり で統一、1画面1問） ======
      // 研究・ガイドライン（一般名）：AHA BLS/ILCOR、BE-FAST、Stop the Bleed、NICE NG232
      const OTHER_STEPS = [
        // 安全：Yes=危険（問題あり）
        { id: "unsafe",  text: "周囲は危険ですか？（車道/火/煙/感電/水辺など）", type: "yesno", onYes: "CALL_NOW" },

        // 反応：Yes=反応がない（問題あり）
        { id: "no_response", text: "呼びかけや肩叩きに反応がないですか？", type: "yesno" },

        // 呼吸：Yes=普段どおりの呼吸がない/不明（問題あり）※反応なしのときだけ
        { id: "no_normal_breath", text: "普段どおりの呼吸がない、または不明ですか？（“あえぎ”はNO）", type: "yesno",
          requires: (ans) => ans["no_response"] === true, onYes: "CALL_NOW" },

        // レッドフラグ（Yes=問題あり）
        { id: "seiz",    text: "けいれんが続いている、または5分以上/反復していますか？", type: "yesno", onYes: "CALL_NOW" },
        { id: "befast",  text: "顔のゆがみ/片腕が上がらない/話し方がおかしい（いずれか）ですか？", type: "yesno", onYes: "CALL_NOW" },
        { id: "cyan",    text: "一息で話せないほど息苦しい、または口唇が青いですか？", type: "yesno", onYes: "CALL_NOW" },
        { id: "bleed",   text: "圧迫しても止まらない、または噴出する出血がありますか？", type: "yesno", onYes: "CALL_NOW" },
        { id: "force",   text: "高所落下/交通事故/頭部を強く打った等の強い外力がありましたか？", type: "yesno", onYes: "CALL_STRONGLY" },
        { id: "anaph",   text: "息苦しさ/声がれ/喉の腫れ＋じんましん/顔の腫れがありますか？", type: "yesno", onYes: "CALL_NOW" },

        // ボーダーライン（Yes=問題あり）
        { id: "chest10",  text: "胸を押さえる/冷汗/嘔気などが10分以上続いていますか？", type: "yesno", onYes: "CALL_STRONGLY" },
        { id: "lethargy", text: "ぐったり/反応鈍い/いつもと違う様子ですか？（高齢者・小児等）", type: "yesno", onYes: "CALL_STRONGLY" },
        { id: "headpost", text: "転倒後に頭痛増悪/嘔吐/ぼんやりがありますか？", type: "yesno", onYes: "CALL_STRONGLY" },

        // リスク増幅（Yesで一段階繰上げ）
        { id: "vuln",   text: "高齢（65+）/小児/妊娠/重い基礎疾患に該当しますか？", type: "yesno" },
        { id: "remote", text: "受診まで1時間以上かかる/夜間独居など支援が乏しいですか？", type: "yesno" },
      ];

      function applyOtherDecision(answers) {
        const yes = (id) => answers[id] === true;

        // 即通報
        if (yes("unsafe")) return "CALL_NOW";
        if (yes("no_response") && yes("no_normal_breath")) return "CALL_NOW";
        if (yes("seiz") || yes("befast") || yes("cyan") || yes("bleed") || yes("anaph")) return "CALL_NOW";

        // 強く推奨
        let strong = (yes("force") || yes("chest10") || yes("lethargy") || yes("headpost"));
        if (strong) {
          let cat = "CALL_STRONGLY";
          const riskUp = (yes("vuln") ? 1 : 0) + (yes("remote") ? 1 : 0);
          if (riskUp >= 1) cat = "CALL_NOW";
          return cat;
        }

        // 残り：同日受診 or 自己ケア（他者フローは情報が少ないため③寄り）
        const riskUp = (yes("vuln") ? 1 : 0) + (yes("remote") ? 1 : 0);
        return riskUp >= 1 ? "SAME_DAY" : "SELF_CARE";
      }

      // ====== メインアプリ ======
      function MainApp() {
        // 共通
        const [routeUserType, setRouteUserType] = useState(null); // "SELF" | "OTHER"
        const [step, setStep] = useState("HOME"); // HOME|USER_PICK|CATEGORY|RED|BORDER|RISK|OTHER_Q|RESULT
        const [timerActive, setTimerActive] = useState(false);
        const [count, setCount] = useState(30);
        const [timeoutOpen, setTimeoutOpen] = useState(false);

        // 自分フロー
        const [selected, setSelected] = useState([]);
        const [focus, setFocus] = useState(null);
        const [answersSelf, setAnswersSelf] = useState({});
        const focusSymptom = useMemo(() => (focus ? SELF_SYMPTOMS.find((s) => s.key === focus) || null : null), [focus]);
        const currentQs = useMemo(() => (!focusSymptom ? { red: null, border: [], risk: [] } : { red: focusSymptom.redFlag, border: focusSymptom.borderline, risk: focusSymptom.risk }), [focusSymptom]);
        const [age65plus, setAge65plus] = useState(false);

        // 他者フロー
        const [answersOther, setAnswersOther] = useState({});
        const [otherIndex, setOtherIndex] = useState(0);

        // 共通結果
        const [category, setCategory] = useState(null);

        // 経過（自分フロー：胸痛等で利用）
        const [startAt, setStartAt] = useState(null);
        const minutesPersisted = useMemo(() => (!startAt ? 0 : Math.max(0, Math.round((Date.now() - startAt) / 60000))), [startAt, step]);

        // タイマー：0でオーバーレイを強制表示
        useEffect(() => {
          if (!timerActive) return;
          if (count <= 0) {
            setTimerActive(false);
            setTimeoutOpen(true);
            return;
          }
          const t = window.setTimeout(() => setCount((s) => s - 1), 1000);
          return () => window.clearTimeout(t);
        }, [timerActive, count]);

        // Home（検索ショートカット：自分フローのみ）
        const [query, setQuery] = useState("");
        const onChoosePopular = (kw) => {
          const map = { "虫に刺された": "skin", "発熱": "fever", "外傷/出血": "trauma" };
          const k = map[kw];
          if (k) {
            setTimerActive(true); setStartAt(Date.now()); setCount(30);
            setStep("USER_PICK");
            // 自分を選んだうえでカテゴリに一発で入る
            setRouteUserType("SELF");
            setStep("CATEGORY");
            setSelected([k]); setFocus(k); setQuery(kw);
          }
        };

        // タイムアウト・オーバーレイのアクション
        const goCallNow = () => { setTimeoutOpen(false); setCategory("CALL_NOW"); setStep("RESULT"); setTimerActive(false); };
        const backToQuestions = () => {
          setTimeoutOpen(false);
          if (routeUserType === "OTHER") { setStep("OTHER_Q"); setCount(10); setTimerActive(true); return; }
          if (!focus) { setStep("CATEGORY"); setCount(30); setTimerActive(true); return; }
          if (step === "RESULT") { setStep("CATEGORY"); setCount(30); setTimerActive(true); return; }
          setCount(step === "HOME" || step === "USER_PICK" || step === "CATEGORY" ? 30 : 10);
          setTimerActive(true);
        };

        // 自分フロー制御
        const proceedFromCategory = () => { if (!focus) return; setStep("RED"); setCount(10); setTimerActive(true); };
        const setAnsSelf = (id, v) => setAnswersSelf((prev) => ({ ...prev, [id]: v }));
        const evaluateSelf = () => {
          if (!focusSymptom) return;
          const riskYes = focusSymptom.risk.reduce((acc, q) => (answersSelf[q.id] ? acc + 1 : acc), 0);
          const cat = focusSymptom.decide(answersSelf, riskYes, minutesPersisted, age65plus);
          setCategory(cat); setStep("RESULT"); setTimerActive(false);
        };

        // 他者フロー制御（1問ずつ表示）
        const curOtherQ = OTHER_STEPS[otherIndex] || null;
        const canShowOtherQ = (q) => !q?.requires || q.requires(answersOther);
        const answerOther = (v) => {
          const q = curOtherQ;
          if (!q) return;
          const nextAnswers = { ...answersOther, [q.id]: v };
          setAnswersOther(nextAnswers);

          // 早期判定（Yesで即時判定が定義されている場合）
          if (v === true && q.onYes === "CALL_NOW")       { setCategory("CALL_NOW"); setStep("RESULT"); setTimerActive(false); return; }
          if (v === true && q.onYes === "CALL_STRONGLY")  { setCategory("CALL_STRONGLY"); setStep("RESULT"); setTimerActive(false); return; }

          // 次の表示可能な質問へ（requiresを満たさないものは飛ばす）
          let idx = otherIndex + 1;
          while (idx < OTHER_STEPS.length && !canShowOtherQ(OTHER_STEPS[idx])) idx++;

          if (idx >= OTHER_STEPS.length) {
            // 全問終了 → 総合判定
            const cat = applyOtherDecision(nextAnswers);
            setCategory(cat); setStep("RESULT"); setTimerActive(false);
          } else {
            setOtherIndex(idx);
            setCount(10);
            setTimerActive(true);
          }
        };

        // 画面
        return (
          <div className="min-h-screen bg-gradient-to-br from-rose-50 via-white to-sky-50 p-4 md:p-8">
            <div className="mx-auto max-w-3xl">
              <header className="flex items-center justify-between mb-4">
                <h1 className="text-2xl md:text-3xl font-extrabold tracking-tight text-neutral-800">救急要請の再判断アシスト（MVP）</h1>
                <span className="inline-flex px-3 py-1 rounded-full bg-black/80 text-white text-xs">迷ったら #7119</span>
              </header>

              <div className="rounded-3xl shadow-xl bg-white/80 backdrop-blur border border-white/60 p-4 md:p-6 relative">
                {/* タイムアウト・オーバーレイ */}
                {timeoutOpen && <TimeoutOverlay onCallNow={goCallNow} onBackToQuestions={backToQuestions} />}

                {/* タイマー */}
                <div className="flex items-center justify-between mb-4 gap-3">
                  <div className="flex items-center gap-3">
                    <CircleTimer seconds={timerActive ? count : 0} total={(step === "HOME" || step === "USER_PICK" || step === "CATEGORY") ? 30 : 10} colorClass={timerActive ? undefined : "stroke-neutral-300"} />
                    <div className="text-sm text-neutral-600">
                      {!timerActive
                        ? <div>「通報するか迷っている」を押すと安全確認タイマーが開始します（自動発信はしません）。</div>
                        : <div>安全確認タイマー作動中。0で<strong>緊急案内オーバーレイ</strong>が出ます。</div>}
                    </div>
                  </div>
                  <a className="h-12 grid place-items-center rounded-xl px-3 bg-neutral-100 text-sm font-semibold"
                     href={LINKS.ABOUT_7119} target="_blank" rel="noopener noreferrer" aria-label="#7119（救急安心センターの案内）を開く">
                    {LINKS.TEL_7119_TEXT}
                  </a>
                </div>

                {/* ステップ */}
                {step === "HOME" && (
                  <div className="space-y-6">
                    <div className="grid gap-3 md:grid-cols-2">
                      <SolidBtn className="bg-neutral-900 text-white" aria-label="通報するか迷っている（フロー開始）"
                        onClick={() => { setTimerActive(true); setStartAt(Date.now()); setCount(30); setStep("USER_PICK"); }}>
                        A. 通報するか迷っている
                      </SolidBtn>
                      <SolidBtn className="bg-red-600 text-white" aria-label="明らかに緊急（すぐに結論画面へ）"
                        onClick={() => { setTimerActive(false); setStep("RESULT"); setCategory("CALL_NOW"); setFocus(null); setRouteUserType(null); }}>
                        B. 明らかに緊急（要請を強く検討）
                      </SolidBtn>
                    </div>

                    <div className="space-y-2">
                      <div className="text-sm font-semibold">クイック検索（自分の症状向け）</div>
                      <input aria-label="クイック検索入力" value={query} onChange={(e) => setQuery(e.target.value)} placeholder="例：虫に刺された／発熱／外傷…" className="h-12 w-full rounded-xl border px-3" />
                      <div className="flex gap-2">
                        {["虫に刺された", "発熱", "外傷/出血"].map((p) => (
                          <button key={p} className="px-3 h-8 rounded-full text-sm bg-neutral-100 hover:bg-neutral-200" aria-label={`クイック選択：${p}`} onClick={() => onChoosePopular(p)}>{p}</button>
                        ))}
                      </div>
                    </div>
                  </div>
                )}

                {step === "USER_PICK" && (
                  <div className="space-y-4">
                    <div className="text-sm text-neutral-700">対象を選んでください。</div>
                    <div className="grid gap-3 md:grid-cols-2">
                      <SolidBtn className="bg-white border font-bold text-neutral-900"
                        onClick={() => { setRouteUserType("SELF"); setStep("CATEGORY"); setCount(30); setTimerActive(true); }}>
                        自分の症状について
                      </SolidBtn>
                      <SolidBtn className="bg-white border font-bold text-neutral-900"
                        onClick={() => {
                          setRouteUserType("OTHER");
                          setAnswersOther({});
                          setOtherIndex(0);
                          setCount(30);
                          setTimerActive(true);
                          setStep("OTHER_Q");
                        }}>
                        他者を見つけた／様子がおかしい人がいる
                      </SolidBtn>
                    </div>
                  </div>
                )}

                {/* 自分の症状：カテゴリ選択 */}
                {step === "CATEGORY" && routeUserType === "SELF" && (
                  <div className="space-y-4">
                    <div className="text-sm text-neutral-600">最も近い項目を選択（複数可）。優先度は自動で決まります。</div>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                      {SELF_SYMPTOMS.map((s) => {
                        const active = selected.includes(s.key);
                        return (
                          <button
                            key={s.key}
                            aria-label={`症状カテゴリを選択：${s.label}`}
                            className={"h-16 rounded-2xl border grid place-items-center text-lg font-semibold shadow-sm " + (active ? "border-blue-500 bg-blue-50" : "border-neutral-200 bg-neutral-50 hover:bg-white")}
                            onClick={() => {
                              setSelected((prev) => {
                                const next = prev.includes(s.key) ? prev.filter((x) => x !== s.key) : [...prev, s.key];
                                const nextFocus = PRIORITY_ORDER.find((k) => next.includes(k)) || next[0] || null;
                                setFocus(nextFocus || null);
                                return next;
                              });
                            }}
                          >
                            <div className="flex items-center gap-3">
                              <span className="text-2xl" aria-hidden="true">{s.emoji}</span>
                              <span>{s.label}</span>
                              {focus === s.key && <span className="text-xs px-2 py-0.5 rounded-full bg-blue-600 text-white">優先</span>}
                            </div>
                          </button>
                        );
                      })}
                    </div>
                    <div className="flex items-center justify-between">
                      <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={age65plus} onChange={(e)=>setAge65plus(e.target.checked)} />該当者は65歳以上</label>
                      <button className="h-12 px-6 rounded-xl bg-blue-600 text-white font-bold disabled:opacity-50"
                        aria-label="次へ（レッドフラグ）" disabled={!focus} onClick={proceedFromCategory}>
                        次へ（レッドフラグ）
                      </button>
                    </div>
                  </div>
                )}

                {/* 自分：レッドフラグ */}
                {step === "RED" && routeUserType === "SELF" && focusSymptom && currentQs.red && (
                  <div className="space-y-6">
                    <div className="flex items-center gap-3">
                      <div className="text-3xl" aria-hidden="true">{focusSymptom.emoji}</div>
                      <div>
                        <div className="text-lg font-bold">{focusSymptom.label}</div>
                        <div className="text-sm text-neutral-600">レッドフラグ（1問/はいで要請を強く検討）</div>
                      </div>
                    </div>
                    <YesNo
                      q={currentQs.red}
                      value={answersSelf[currentQs.red.id]}
                      onAnswer={(v) => {
                        setAnsSelf(currentQs.red.id, v);
                        if (v === true) { setCategory("CALL_NOW"); setStep("RESULT"); setTimerActive(false); }
                        else { setStep(currentQs.border.length ? "BORDER" : currentQs.risk.length ? "RISK" : "RESULT"); setCount(10); setTimerActive(true); }
                      }}
                    />
                  </div>
                )}

                {/* 自分：ボーダーライン */}
                {step === "BORDER" && routeUserType === "SELF" && focusSymptom && (
                  <div className="space-y-6">
                    <div className="flex items-center gap-3">
                      <div className="text-3xl" aria-hidden="true">{focusSymptom.emoji}</div>
                      <div>
                        <div className="text-lg font-bold">{focusSymptom.label}</div>
                        <div className="text-sm text-neutral-600">ボーダーライン確認（最大4問）</div>
                      </div>
                    </div>
                    <div className="grid gap-4">
                      {focusSymptom.borderline.map((q) => (
                        <YesNo key={q.id} q={q} value={answersSelf[q.id]} onAnswer={(v) => setAnsSelf(q.id, v)} />
                      ))}
                    </div>
                    <div className="flex justify-end">
                      <button className="h-12 px-6 rounded-xl bg-blue-600 text-white font-bold"
                        aria-label="次へ（危険因子または判定へ）"
                        onClick={() => { setStep(focusSymptom.risk.length ? "RISK" : "RESULT"); setCount(10); setTimerActive(true); }}>
                        次へ
                      </button>
                    </div>
                  </div>
                )}

                {/* 自分：危険因子 */}
                {step === "RISK" && routeUserType === "SELF" && focusSymptom && (
                  <div className="space-y-6">
                    <div className="flex items-center gap-3">
                      <div className="text-3xl" aria-hidden="true">{focusSymptom.emoji}</div>
                      <div>
                        <div className="text-lg font-bold">{focusSymptom.label}</div>
                        <div className="text-sm text-neutral-600">危険因子（該当で一段階繰り上げ）</div>
                      </div>
                    </div>
                    <div className="grid gap-4">
                      {focusSymptom.risk.map((q) => (
                        <YesNo key={q.id} q={q} value={answersSelf[q.id]} onAnswer={(v) => setAnsSelf(q.id, v)} />
                      ))}
                    </div>
                    <div className="flex justify-end">
                      <button className="h-12 px-6 rounded-xl bg-blue-600 text-white font-bold" aria-label="判定" onClick={evaluateSelf}>
                        判定
                      </button>
                    </div>
                  </div>
                )}

                {/* 他者観察：1画面1問のみ表示 */}
                {step === "OTHER_Q" && routeUserType === "OTHER" && (
                  <div className="space-y-6">
                    <div className="text-lg font-bold">他者の観察（目撃者用）</div>
                    <div className="text-sm text-neutral-600">見てわかる項目だけ答えてください。Yesは「体調に問題あり」です。</div>

                    {(() => {
                      const q = OTHER_STEPS[otherIndex];
                      if (!q) return <div className="text-sm">判定中…</div>;
                      // requires未充足ならスキップ
                      if (q.requires && !q.requires(answersOther)) {
                        // 非同期スキップ
                        setTimeout(() => {
                          let idx = otherIndex + 1;
                          while (idx < OTHER_STEPS.length && OTHER_STEPS[idx].requires && !OTHER_STEPS[idx].requires(answersOther)) idx++;
                          setOtherIndex(idx);
                        }, 0);
                        return null;
                      }
                      return (
                        <YesNo
                          q={{ text: q.text }}
                          value={answersOther[q.id]}
                          onAnswer={(v) => {
                            const next = { ...answersOther, [q.id]: v };
                            setAnswersOther(next);

                            // 即時判定
                            if (v === true && q.onYes === "CALL_NOW")      { setCategory("CALL_NOW"); setStep("RESULT"); setTimerActive(false); return; }
                            if (v === true && q.onYes === "CALL_STRONGLY") { setCategory("CALL_STRONGLY"); setStep("RESULT"); setTimerActive(false); return; }

                            // 次の質問へ
                            let idx = otherIndex + 1;
                            while (idx < OTHER_STEPS.length && OTHER_STEPS[idx].requires && !OTHER_STEPS[idx].requires(next)) idx++;
                            if (idx >= OTHER_STEPS.length) {
                              const cat = applyOtherDecision(next);
                              setCategory(cat); setStep("RESULT"); setTimerActive(false);
                            } else {
                              setOtherIndex(idx);
                              setCount(10);
                              setTimerActive(true);
                            }
                          }}
                        />
                      );
                    })()}
                  </div>
                )}

                {/* 結果 */}
                {step === "RESULT" && (
                  <ResultBlock category={category ?? "CALL_NOW"} consultLinks={category === "SAME_DAY" || category === "SELF_CARE"} />
                )}
              </div>

              <footer className="text-xs text-neutral-600 mt-4 leading-relaxed space-y-2">
                <div>
                  本サイトは救急要請の「再判断」を支援する一般情報です。診断・治療の指示は行いません。迷ったら #7119 等の公的窓口を利用してください。
                </div>
                <div className="flex items-center gap-3">
                  <a href="#/terms" className="underline hover:no-underline" aria-label="利用規約を開く">利用規約</a>
                  <a href="#/privacy" className="underline hover:no-underline" aria-label="プライバシーポリシーを開く">プライバシーポリシー</a>
                </div>
              </footer>
            </div>

            {/* 背景装飾 */}
            <div className="pointer-events-none fixed inset-0 -z-10 opacity-60" aria-hidden="true">
              <div className="absolute -top-24 -left-24 w-80 h-80 bg-rose-200 blur-3xl rounded-full"></div>
              <div className="absolute -bottom-32 -right-16 w-96 h-96 bg-sky-200 blur-3xl rounded-full"></div>
            </div>
          </div>
        );
      }

      // ====== 利用規約ビュー ======
      function TermsView() {
        return (
          <main className="min-h-screen bg-white p-6 md:p-10">
            <div className="mx-auto max-w-3xl">
              <header className="flex items-center justify-between mb-6">
                <h1 className="text-2xl md:text-3xl font-extrabold">利用規約</h1>
                <a href="#/" className="text-sm underline">← トップへ戻る</a>
              </header>
              <article className="prose max-w-none">
                <p>本サービスは、救急要請の「再判断」を支援する一般情報を提供するものであり、診断・治療の指示は行いません。最終的な行動決定はご利用者の責任で行ってください。迷った場合は #7119 等の公的窓口をご利用ください。</p>
                <h2>免責</h2>
                <p>本サービスの情報の正確性・有用性について保証するものではありません。ご利用により生じたいかなる損害に対しても、当方は法令で認められる範囲で責任を負いません。</p>
                <h2>提供情報の性質</h2>
                <p>公的ガイドライン（AHA/ILCOR, BE-FAST, Stop the Bleed, NICE等の一般原則）に基づく一般的な情報を提示しますが、個別の医療判断を代替するものではありません。</p>
                <h2>禁止事項</h2>
                <ul className="list-disc pl-5">
                  <li>本サービスを医療判断の代替として使用すること</li>
                  <li>本サービスの無断改変・再配布</li>
                </ul>
                <h2>規約の変更</h2>
                <p>必要に応じて本規約を変更する場合があります。変更後の規約は、本ページに掲載した時点から効力を生じます。</p>
              </article>
            </div>
          </main>
        );
      }

      // ====== プライバシーポリシービュー ======
      function PrivacyView() {
        return (
          <main className="min-h-screen bg-white p-6 md:p-10">
            <div className="mx-auto max-w-3xl">
              <header className="flex items-center justify-between mb-6">
                <h1 className="text-2xl md:text-3xl font-extrabold">プライバシーポリシー</h1>
                <a href="#/" className="text-sm underline">← トップへ戻る</a>
              </header>
              <article className="prose max-w-none">
                <h2>基本方針</h2>
                <p>本サービスは、利用者の個人情報（氏名、住所、連絡先、症状等）をサーバに保存しません。位置情報は端末内での表示に限定し、サーバ送信を行いません。</p>
                <h2>アクセス解析等の外部送信</h2>
                <p>現時点で第三者への外部送信は行っていません。将来、解析ツールを導入する場合は、送信先・送信項目・目的を本ページに明記し、必要な同意を取得します。</p>
                <h2>ログの取り扱い</h2>
                <p>品質改善のため匿名の操作ログを収集する場合は、取得項目・保存期間・利用目的を明記し、オプトインの同意を得ます。</p>
                <h2>お問い合わせ</h2>
                <p>ご質問は運営者連絡先までご連絡ください。</p>
              </article>
            </div>
          </main>
        );
      }

      // ====== ルートコンテナ ======
      function Root() {
        const [route] = useHashRoute();
        if (route.indexOf("/terms") === 0) return <TermsView />;
        if (route.indexOf("/privacy") === 0) return <PrivacyView />;
        return <MainApp />;
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<Root />);
    </script>
  </body>
</html>
